---
title: "Buses"
author: Tom Elliott
date: "25 August 2020"
output:
    revealjs::revealjs_presentation:
        theme: serif
        center: false
        slide_level: 1
        mathjax: default
        reveal_options:
            controls: false
            hash: true
        transition: none
bibliography: reflist.bib
csl: apa.csl
---


# Part I
```{sass, echo=FALSE}
$col1: #18afe3
$col2: #094b85
.reveal
    pre
        margin-top: 5px
        margin-bottom: 5px

    section
        text-align: left
        strong
            color: $col1

        /*ul>li>span
            color: $col1*/

        ul>li>ul
            font-size: 0.6em
            list-style-type: '&ndash; '
/***/
```

What is the status quo, and what is wrong with it?

***
## In Auckland ...

* real-time vehicle locations
* arrival and departure times/delays <br><br>
* ETA = scheduled arrival + current delay
* *no use of location information, traffic, historical, ...*


***
## Around the world ...

* many unique real-time information systems
* various data feeds:
    * *vehicle positions, passenger counters, taxis, ...*
* equally different prediction systems
    * *Kalman filter, artificial neural network, support vector machines, ...*
  <br><br>
* GTFS: *General Transit Feed Specification*
* decribes *how* to organise and format transit data
* GTFS-realtime: API specification


***
## Vehicle models

* operations management
    * *on-time performance, reducing bunching behaviour, ...*
* little recent focus on ETAs
    * Kalman filter (e.g., @Dailey_2001, @Cathey_2003)
    * ANN/SVM (e.g., @Yu_2006, ...)
* but lots of cool models
    * particle filtering (e.g., @Hans_2015)
    * other models?

***
## Traffic models

* essential for reliable predictions
* difficult to model (data availability, ...)
* location-specific examples
    * @Yu_2011 *previous bus along same road, different route*
    * @Julio_2016 *traffic shockwaves*
    * ... *taxi data*<br><br>
* vast majority of transit feeds use *only* GTFS

***
## Arrival time prediction & journey planning

* current position, travel times, dwell times
* GTFS-realtime default is *schedule + current delay*
* usually a point estimate "*ETA: 5 mins*"<br><br>
* JP is hard (@Horn_2004, @Hame_2013a)
* Simple to complex questions
    * which bus to arrive on time
    * which set of buses to get to destination fastest
    * minimal waiting time between legs
* Some frameworks, nothing inherent to GTFS (i.e., general)
    * decisions using probabilitic arrival time information [@Berczi_2017]

# Part II

Bus arrival prediction using real-time network state

***
1. GTFS network construction
2. Vehicle model
3. Transit network model
4. Arrival time prediction
5. Journey planning


***
## 1. GTFS network construction

```{r,eval=F}
library(transitr)
nw <- create_gtfs("https://cdn01.at.govt.nz/data/gtfs.zip",
    db = "at_gtfs.sqlite")
nw %>% construct()
```

```{r, echo=F, fig.width=10,fig.height=4,message=FALSE,warning=FALSE}
library(RSQLite)
library(dplyr)
library(dbplyr)
library(magrittr)
con <- dbConnect(SQLite(), 'at_gtfs.sqlite')
routes <- con %>% tbl('routes') %>%
    filter(
        route_short_name %in% c('27W', '24R', '22A') &
        (route_long_name %like% '%To City%' | route_long_name %like% '%To Britomart%') &
        version == 94.7
    ) %>% select(route_id, route_short_name, route_long_name) %>% collect()
trips <- con %>% tbl('trips') %>%
    filter(
        route_id %in% !!routes$route_id
    ) %>%
    select(route_id, trip_id, shape_id) %>%
    group_by(route_id) %>%
    summarize(trip_id = min(trip_id, na.rm = TRUE), shape_id = min(shape_id, na.rm = TRUE)) %>%
    collect() %>%
    left_join(routes, by = 'route_id')
shapes <- con %>% tbl('shapes') %>%
    filter(shape_id %in% !!trips$shape_id) %>%
    select(shape_id, shape_pt_lat, shape_pt_lon, shape_pt_sequence) %>%
    collect() %>%
    left_join(trips, by = 'shape_id') %>%
    filter(
        shape_pt_lat > -36.875 &
        shape_pt_lon > 174.74
    )
stops <- con %>% tbl('stop_times') %>%
    filter(
        trip_id %in% !!trips$trip_id
    ) %>%
    left_join(con %>% tbl('stops'), by = 'stop_id') %>%
    select(stop_code, trip_id, stop_sequence, stop_lat, stop_lon) %>%
    collect() %>%
    left_join(trips, by = 'trip_id') %>%
    filter(
        stop_lat > -36.875 &
        stop_lon > 174.74
    ) %>%
    arrange(route_short_name, stop_sequence)
stops2 <- stops %>%
    mutate(
        stop_lat = ifelse(stop_code %in% c('8213', '8211'), stop_lat + 0.0015, stop_lat)
    )

dbDisconnect(con)

library(ggplot2)
pp <- ggplot(shapes, aes(shape_pt_lon, shape_pt_lat, colour = route_short_name)) +
    coord_fixed(ratio = 0.8) +
    theme_void() +
    theme(legend.position = "bottom") +
    labs(colour = "")

pp + facet_grid(~route_short_name) +
    geom_path(lwd = 2)
    # geom_point(aes(stop_lon, stop_lat), data = stops)
```

***
## 1. GTFS network construction

```{r,eval=F}
library(transitr)
nw <- create_gtfs("https://cdn01.at.govt.nz/data/gtfs.zip",
    db = "at_gtfs.sqlite")
nw %>% construct()
```

```{r, echo=F, fig.width=10,fig.height=4,message=FALSE,warning=FALSE}
pp +
    geom_path(lwd = 2) +
    geom_path(aes(linetype = route_short_name), lwd = 2) +
    geom_point(aes(stop_lon, stop_lat, colour = NULL), data = stops) +
    labs(linetype = "")
```


***
## 1. GTFS network construction

```{r,eval=F}
library(transitr)
nw <- create_gtfs("https://cdn01.at.govt.nz/data/gtfs.zip",
    db = "at_gtfs.sqlite")
nw %>% construct()
```

```{r, echo=F, fig.width=10,fig.height=4,message=FALSE,warning=FALSE}
pp +
    geom_path(aes(stop_lon, stop_lat), lwd = 2, data = stops2) +
    geom_path(aes(stop_lon, stop_lat, linetype = route_short_name), lwd = 2, data = stops2) +
    geom_point(aes(stop_lon, stop_lat, colour = NULL), data = stops2) +
    labs(linetype = "")
```

***
## 2. Vehicle model

* Observations $\boldsymbol{y}_1, \boldsymbol{y}_2, \cdots, \boldsymbol{y}_{k-1}, \boldsymbol{y}_k$
* Underlying state $\boldsymbol{x}_0, \boldsymbol{x}_1, \cdots, \boldsymbol{x}_{k-2}, \boldsymbol{x}_k$<br><br>
* Recursive Bayesian estimation
    * **Predict**: model bus behaviour
    * **Update**: likelihood of observation (given prediction)
* Estimates distance, speed,
  *average speed along each road segment*

***
## 3. Transit network model

* Observations $b_{v\ell c}$ with error $e_{v\ell c}$
    * average speed of vehicle $v$, road $\ell$, time period $(t_{c-1},t_c]$
* Underlying state $\beta_{\ell c}$ (average vehicle speed, m/s)<br><br>
* Heirarchical structure
\[
    \begin{split}
    b_{v\ell c} &\sim \mathcal{N}(B_{v\ell c}, e_{v\ell c}^2) \\
    B_{v\ell c} &\sim \mathcal{N}_T(\beta_{\ell c}, \phi_\ell^2) \\
    \beta_{\ell c} &\sim \mathcal{N}_T(F_c(\beta_{\ell,c-1}, \Delta_c), q^2),\quad
        \Delta_c = t_c - t_{c-1}
    \end{split}
\]

***
## 3. Transit network model

* Historical data to estimate $\phi_\ell$ and $q$
* JAGS [@JAGS]<br><br>
* Kalman filter: real-time network state
    * $\hat \beta_{c|c-1} = \mathbb{E}(\beta_c | b_{0:c-1})$
    * $P_{c|c-1} = \mathrm{Var}(\beta_c | b_{0:c-1})$
* Information filter
    * Multiple vehicles/segment/time period
    * Limited to independent segments

***
## 3. Transit network model

* Predict:
    \[
    \begin{split}
        \hat\beta_{c|c-1} &= \hat\beta_{c-1|c-1} \\
        P_{c|c-1} &= P_{c|c-1} + (\Delta_c q)^2
    \end{split}
    \]

***
## 3. Transit network model

* Information matrix, vector \[U = P^{-1}, \quad u = \hat\beta P^{-1}\]
* Obs. inf. matrix, vector *includes between-vehicle variance*
  \[I_v = (\phi^2 + e_v^2)^{-1},\quad i_v = b_v (\phi^2 + e_v^2)^{-1}\]
* Sum everything together
\[
    \begin{split}
    U_{c|c} = U_{c|c-1} + \sum_v I_{v,c} \\
    u_{c|c} = u_{c|c-1} + \sum_v i_{v,c}
    \end{split}
\]
* Back-transform

***
## 4. Arrival time prediction

* ETA = travel time + dwell time
*


***
## 5. Journey planning


# Part III

Using particle filtering to model vehicles and generate arrival time distributions

1. particle filter to estimate vehicle state and road travel times
2. road travel times update road network state (KF)
3. vehicle state + road state = ETAs


# Thank you



# Appendix

Some slides ...
