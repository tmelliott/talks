---
title: Travel times<br>&amp;</br>bus prediction
author: "<img src='double-decker-2016.jpg' width=450><br>
<small>Tom Elliott</small>"
date: "<small>PhD Talks Day 2019</small>"
output: 
    revealjs::revealjs_presentation:
        theme: sky
        center: true
        slide_level: 1
        mathjax: default
        reveal_options:
            controls: false
            hash: true
        transition: none
---


# Overview

GPS positions

$\downarrow$

Travel times

$\downarrow$

Network state

$\downarrow$

Arrival time distributions

$\downarrow$

ETAs


# <small>Part One</small><br>GPS positions<span style="margin:0.5em;display:block">$\downarrow$</span>travel times

----

<h2>Real-time vehicle locations</h2>

- Auckland Transport provides API for real-time data 
- __Vehicle locations__: GPS coordinates of buses/trains
- __Trip updates__: arrival/departure times at bus stops


----
<h2>Vehicle state</h2>

- Unknown vehicle state $X_k = [x_k, \dot x_k]^\top$, at time $t_k$
    - $x_k$: distance travelled along route, meters
    - $\dot x_k$: speed, meters per second
- Observable state $Y_k = h(X_k) + \epsilon_k$

----

[X] ->
[h(X)] -> 
[Y = h(X) + e]


----
<h2>Particle filter</h2>

- Approximate vehicle state using sample of $N$ particles
\[
p(X_{k-1} | Y_{1:k-1}) \approx
\sum_{i=1}^N W_{k-1}^{(i)} \delta(X_{k-1} - X_{k-1}^{(i)})
\]
- $X_{k-1}^{(i)}$: state (distance and velocity) of particle $i$
- $W_{k-1}^{(i)}$: weight of particle $i$
- $\delta()$: Dirac delta function


----
<h2>Particle filter ii</h2>

- Predict new state using __vehicle transition function__, $f$

\[
X_k^{(i)} = f(X_{k-1}^{(i)}, \sigma_x^2, ...)
\]

\[
p(X_{k} | X_{k-1}) \approx
\sum_{i=1}^N W_{k-1}^{(i)} \delta(X_{k} - X_k^{(i)})
\]

----
<h2>Particle filter iii</h2>

- Vehicle likelihood function based on squared distance between particle and observation,
and GPS error $\epsilon^2$ <div style='margin-bottom: 0.5em'></div>
\[
d(Y_k, h(X_k^{(i)}))^2 \sim Exp\left(\frac{1}{2\epsilon^2}\right)
\]

- Update vehicle state by reweighting particles

\[
W_k^{(i)} = \frac{W_k^{(i)} p(Y_k | X_k^{(i)})}{\sum_{j=1}^N W_k^{(j)} p(Y_k | X_k^{(j)})}
\]

\[
p(X_k | Y_k) \approx
\sum_{i=1}^N W_{k}^{(i)} \delta(X_{k} - X_k^{(i)})
\]


----

[Y and h(X) on a map]

->

[Y and h(X) projected to flat surface]

->

[squared distance is sum of two squared iid standard normal rvs]

-> which is exp()


----
<h2>Estimating travel times</h2>

- For road segment $j$ completed at time $t_k$, 
each particle has a known travel time $T_j$
- Posterior estimate of travel time easily computed
\[
p(T_j | Y_{1:k}) \approx
\sum_{i=1}^N W_{k}^{(i)} \delta(T_{j} - T_j^{(i)})
\]


# <small>Part Two</small><br>Travel times<span style="margin:0.5em;display:block">$\downarrow$</span>Network state

----
<h2>Transit road network</h2>

- __road network__ consists of all $M$ __road segments__
- each road segment
    - connects two intersections
    - is used by at least one (bus) route
    - doesn't overlap another road segment


----
<h2>Network state</h2>

- travel time (s) of buses along segments at time $t_c$
\[
\Theta_c = 
[
\theta_{1c}, \theta_{2c}, \cdots, \theta_{Mc}
]^\top
\]
- travel times observed as buses traverse the network
    - multiple buses may traverse a segment at a time

- assume state is multivariate normal
\[
\hat\Theta_{c|c} = \mathrm{E}(\Theta_c | T_{1:c})
\quad\text{and}\quad
\Xi_{c|c} = \mathrm{Var}(\Theta_c | T_{1:c})
\]


----
<h2>Information filter</h2>

- alternate form of Kalman filter
- represent mean and variance as __information matrix__ and __information vector__
\[
P_{c-1|c-1} = \Xi_{c-1|c-1}^{-1}
\quad\text{and}\quad
p_{c-1|c-1} = \Xi_{c-1|c-1}^{-1}\hat\Theta_{c-1|c-1}
\]
- allows summing of observation information over multiple observations


----
<h2>Information filter ii</h2>

- predict next state
    - assume travel times constant over short periods
    - system noise is $\rho^2$ (s/s)
- standard Kalman filter predict equations
\[
\begin{split}
\hat\Theta_{c|c-1} &= \hat\Theta_{c-1|c-1} \\
\Xi_{c|c-1} &= \Xi_{c-1|c-1} + I \rho^2
\end{split}
\]


----
<h2>Information filter iii</h2>

- transform travel times observations for each bus $\ell$ with measurement uncertainty $R_c$
    - $I_{c\ell} = R_c^{-1}$
    - $i_{c\ell} = R_c^{-1} T_{j\ell}$
- update state by adding information
\[
\begin{split}
P_{c|c} &= P_{c|c-1} + \sum_\ell I_{c\ell} \\
p_{c|c} &= p_{c|c-1} + \sum_\ell i_{c\ell}
\end{split}
\]
- back transform for state parameters


----
<h2>Information filter iv</h2>

- what if $M$ is big? (it is ...)
- we aren't computing any correlations in observations
    - so $R$ and $I$ are diagnoal
- limit correlations to adjacent road segments
    - $\Xi$ and $P$ are sparse
    - Eigen c++ library

this is all wrong ...


# <small>Part Three</small><br>Network state<span style="margin:0.5em;display:block">$\downarrow$</span>Arrival time distrutions


# <small>Part Four</small><br>Arrival time distrutions<span style="margin:0.5em;display:block">$\downarrow$</span>ETAs
